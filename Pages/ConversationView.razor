@page "/chats/{ConversationId:guid}"
@using System.Net.Http.Json
@using CSE325_Team12_Project.Models.DTOs
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient Http
@inject AuthClientService AuthClient
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="chat-box">
    <div class="chat-header">
        <div class="d-flex align-items-center gap-3">
            <img src="@GetAvatar(otherParticipant?.AvatarUrl)" alt="Profile Icon" width="50px" />
            <div>
                <h3 class="conversation-name">
                    @(otherParticipant != null ? otherParticipant.Name : "Loading user...")
                </h3>
                <p class="text-muted user-email">email@example.com</p>
            </div>
        </div>
        <button class="options-button">‚ãÆ</button>
    </div>

    @if (conversation != null)
    {
        <div class="chat-body">
            <div class="chat-messages" @ref="chatMessagesRef">
                @foreach (var msg in chatMessages.OrderBy(m => m.CreatedAt))
                {
                    var isMine = msg.SenderId == AuthClient.CurrentUser?.Id;
                    <div class="chat-bubble @(isMine ? "mine" : "theirs")">
                        <div class="chat-content">@msg.Content</div>
                        <small class="text-muted">@msg.CreatedAt.ToLocalTime().ToString("g")</small>
                    </div>
                }
            </div>

            <div class="chat-input">
                <EditForm Model="@newMessage" OnValidSubmit="@SendMessage">
                <InputTextArea class="text-area" @bind-Value="newMessage.Content" rows="1"
                    placeholder="Type your message..." />
                <div class="d-flex justify-content-center">
                    <button class="btn btn-primary" type="submit" disabled="@isSending">Send</button>
                </div>
            </EditForm>
            
            </div>


        </div>
    }
    else
    {
        <p class="text-center mt-5">Loading conversation...</p>
    }

</div>



@code {
    [Parameter] public Guid ConversationId { get; set; }

    private ConversationDto? conversation;
    private List<MessageDto> chatMessages = new();
    private bool isSending = false;
    private bool hasRendered = false;

    private ConversationParticipantDto? otherParticipant;

    private MessageRequest newMessage = new();
    private HubConnection? hubConnection;
    private ElementReference chatMessagesRef;

    private string GetAvatar(string? url) => string.IsNullOrWhiteSpace(url) ? "images/Profile.svg" : url;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasRendered)
        {
            hasRendered = true;

            var restored = await AuthClient.RestoreSessionAsync();
            if (!restored)
            {
                Console.WriteLine("‚ùå Unable to restore session.");
                return;
            }

            
            int attempts = 0;
            while (AuthClient.CurrentUser == null && attempts < 10)
            {
                await Task.Delay(200);
                attempts++;
            }
            if (AuthClient.CurrentUser == null)
            {
                Console.WriteLine("‚ùå Current user not available after waiting.");
                return;
            }

            await LoadConversation();

            newMessage.ConversationId = ConversationId;
            newMessage.TroupeId = null;
            newMessage.SenderId = AuthClient.CurrentUser.Id;

            await InitializeSignalR();

            StateHasChanged();
        }

        // Scroll al final despu√©s de renderizar
        await ScrollToBottomAsync();
    }

    private async Task ScrollToBottomAsync()
    {
        await JS.InvokeVoidAsync("scrollToBottom", chatMessagesRef);
    }

    private async Task LoadConversation()
    {
        try
        {
            conversation = await Http.GetFromJsonAsync<ConversationDto>($"/api/Conversations/{ConversationId}");
            chatMessages = conversation?.Messages.OrderBy(m => m.CreatedAt).ToList() ?? new();
            otherParticipant = conversation?.OtherParticipant;
        }
        catch (HttpRequestException ex)
        {
            Console.Error.WriteLine($"‚ùå Failed to load conversation: {ex.Message}");
            conversation = null;
        }
    }

    private async Task InitializeSignalR()
    {
        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
        .WithAutomaticReconnect()
        .Build();

        // üîÑ SignalR Listener: Refresh UI only if incoming message matches current conversation
        hubConnection.On<MessageDto>("ReceiveDirectMessage", async msg =>
        {
            if (msg.ConversationId == ConversationId)
            {
                chatMessages.Add(msg);
                chatMessages = chatMessages.OrderBy(m => m.CreatedAt).ToList();
                await InvokeAsync(StateHasChanged);
                await InvokeAsync(ScrollToBottomAsync);
            }
        });

        await hubConnection.StartAsync();
        await hubConnection.SendAsync("JoinConversation", ConversationId.ToString());
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage.Content)) return;

        isSending = true;

        var response = await Http.PostAsJsonAsync("/api/Message/send", newMessage);
        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            Console.Error.WriteLine($"‚ùå Message send failed: {response.StatusCode} - {error}");
        }

    newMessage.Content = string.Empty;
    isSending = false;
    await ScrollToBottomAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.SendAsync("LeaveConversation", ConversationId.ToString());
            await hubConnection.DisposeAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.SendAsync("LeaveConversation", ConversationId.ToString());
            await hubConnection.DisposeAsync();
            hubConnection = null;
        }

        await LoadConversation();

        if (AuthClient.CurrentUser != null)
        {
            newMessage.ConversationId = ConversationId;
            newMessage.TroupeId = null;
            newMessage.SenderId = AuthClient.CurrentUser.Id;

            await InitializeSignalR();
        }
        else
        {
            Console.Error.WriteLine("‚ùå Usuario no autenticado. No se puede inicializar la conversaci√≥n.");
        }

        StateHasChanged();
    }

    public class MessageRequest
    {
        public Guid SenderId { get; set; }
        public string Content { get; set; } = string.Empty;
        public Guid? TroupeId { get; set; }
        public Guid? ConversationId { get; set; }
    }

}